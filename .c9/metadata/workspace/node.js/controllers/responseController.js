{"filter":false,"title":"responseController.js","tooltip":"/node.js/controllers/responseController.js","undoManager":{"mark":100,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":15,"column":31},"end":{"row":15,"column":32},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":32},"end":{"row":15,"column":33},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":33},"end":{"row":15,"column":34},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":34},"end":{"row":15,"column":35},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":34},"end":{"row":15,"column":35},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":33},"end":{"row":15,"column":34},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":32},"end":{"row":15,"column":33},"action":"remove","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":32},"end":{"row":15,"column":33},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":32},"end":{"row":15,"column":33},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":32},"end":{"row":15,"column":33},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":33},"end":{"row":15,"column":34},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":34},"end":{"row":15,"column":35},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":35},"end":{"row":15,"column":36},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":36},"end":{"row":15,"column":37},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":37},"end":{"row":15,"column":38},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":38},"end":{"row":15,"column":39},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":39},"end":{"row":15,"column":40},"action":"insert","lines":[";"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":21},"end":{"row":15,"column":22},"action":"remove","lines":["-"]}]}],[{"group":"doc","deltas":[{"start":{"row":15,"column":21},"end":{"row":15,"column":22},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":20,"column":20},"end":{"row":21,"column":0},"action":"insert","lines":["",""]},{"start":{"row":21,"column":0},"end":{"row":21,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":12},"end":{"row":24,"column":16},"action":"insert","lines":[" User.find({username: req.body.user_id }, function(err, user) {","        if (err){","             res.status('400').send(\"No user with that name!\");","        } else {"]}]}],[{"group":"doc","deltas":[{"start":{"row":24,"column":16},"end":{"row":25,"column":0},"action":"insert","lines":["",""]},{"start":{"row":25,"column":0},"end":{"row":25,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":12},"end":{"row":26,"column":0},"action":"insert","lines":["",""]},{"start":{"row":26,"column":0},"end":{"row":26,"column":12},"action":"insert","lines":["            "]}]}],[{"group":"doc","deltas":[{"start":{"row":26,"column":12},"end":{"row":26,"column":13},"action":"insert","lines":["}"]},{"start":{"row":26,"column":0},"end":{"row":26,"column":12},"action":"remove","lines":["            "]},{"start":{"row":26,"column":0},"end":{"row":26,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":24},"end":{"row":21,"column":32},"action":"remove","lines":["username"]},{"start":{"row":21,"column":24},"end":{"row":21,"column":25},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":25},"end":{"row":21,"column":26},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":26},"end":{"row":21,"column":27},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":43},"end":{"row":22,"column":0},"action":"insert","lines":["",""]},{"start":{"row":22,"column":0},"end":{"row":22,"column":13},"action":"insert","lines":["             "]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":12},"end":{"row":22,"column":13},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":8},"end":{"row":22,"column":12},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":4},"end":{"row":22,"column":8},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":0},"end":{"row":22,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":43},"end":{"row":22,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":21,"column":42},"end":{"row":21,"column":43},"action":"remove","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":4},"end":{"row":22,"column":8},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":22,"column":8},"end":{"row":22,"column":12},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":24,"column":4},"end":{"row":24,"column":8},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":24,"column":8},"end":{"row":24,"column":12},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":23,"column":8},"end":{"row":23,"column":12},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":26,"column":8},"end":{"row":26,"column":12},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":22},"end":{"row":28,"column":0},"action":"insert","lines":["",""]},{"start":{"row":28,"column":0},"end":{"row":28,"column":8},"action":"insert","lines":["        "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":12},"end":{"row":25,"column":16},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":16},"end":{"row":25,"column":17},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":17},"end":{"row":25,"column":18},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":18},"end":{"row":25,"column":19},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":19},"end":{"row":25,"column":20},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":20},"end":{"row":25,"column":21},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":21},"end":{"row":25,"column":22},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":22},"end":{"row":25,"column":23},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":23},"end":{"row":25,"column":24},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":24},"end":{"row":25,"column":25},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":25},"end":{"row":25,"column":26},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":26},"end":{"row":25,"column":27},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":27},"end":{"row":25,"column":28},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":27},"end":{"row":25,"column":28},"action":"remove","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":26},"end":{"row":25,"column":27},"action":"remove","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":26},"end":{"row":25,"column":27},"action":"insert","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":27},"end":{"row":25,"column":28},"action":"insert","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":28},"end":{"row":25,"column":29},"action":"insert","lines":[";"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":21},"end":{"row":25,"column":26},"action":"remove","lines":["score"]},{"start":{"row":25,"column":21},"end":{"row":25,"column":22},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":22},"end":{"row":25,"column":23},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":23},"end":{"row":25,"column":24},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":24},"end":{"row":25,"column":25},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":25},"end":{"row":25,"column":26},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":26},"end":{"row":25,"column":27},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":26},"end":{"row":25,"column":27},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":25},"end":{"row":25,"column":26},"action":"remove","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":24},"end":{"row":25,"column":25},"action":"remove","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":24},"end":{"row":25,"column":25},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":25},"end":{"row":25,"column":26},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":26},"end":{"row":25,"column":27},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":28},"end":{"row":25,"column":29},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":27},"end":{"row":25,"column":28},"action":"remove","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":27},"end":{"row":25,"column":28},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":28},"end":{"row":25,"column":29},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":29},"end":{"row":25,"column":30},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":30},"end":{"row":25,"column":31},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":31},"end":{"row":25,"column":32},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":32},"end":{"row":25,"column":33},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":33},"end":{"row":25,"column":34},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":34},"end":{"row":25,"column":35},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":35},"end":{"row":25,"column":36},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":36},"end":{"row":25,"column":37},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":37},"end":{"row":25,"column":38},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":38},"end":{"row":25,"column":39},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":39},"end":{"row":25,"column":40},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":40},"end":{"row":25,"column":41},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":41},"end":{"row":25,"column":42},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":42},"end":{"row":25,"column":43},"action":"insert","lines":["+"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":43},"end":{"row":25,"column":44},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":44},"end":{"row":25,"column":45},"action":"insert","lines":["q"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":28},"end":{"row":25,"column":29},"action":"remove","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":28},"end":{"row":25,"column":29},"action":"insert","lines":["1"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":28},"end":{"row":25,"column":29},"action":"remove","lines":["1"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":28},"end":{"row":25,"column":29},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":44},"end":{"row":25,"column":45},"action":"remove","lines":["q"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":44},"end":{"row":25,"column":45},"action":"insert","lines":["1"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":124,"column":1},"action":"remove","lines":["","var Response = require('../models/responses');","var Request = require('../models/requests');","var User = require('../models/users');","","","","exports.createResponse = function(req, res) {","    console.log('here')","    var response = new Response(); // create a new instance of the Req model","    response.userid = req.body.userid; //","    response.reqid  = req.body.reqid; // ","    response.recipId = req.body.recipId//","    response.time   = req.body.time; //","    response.image    = req.body.image; //","    response.message = req.body.message;","    ","    ","    ","     User.count({_id: req.body.userid}, function (err, count){ ","        if(count>0){","             User.find({_id: req.body.userid }, function(err, user) {","                if (err){","                 res.status('400').send(\"No user with that name!\");","                } else {","                user.points = user.points + 1;","            }","        //user exists ","        });","        } else {","            res.status('400').send(\"User does not exsit\");","            return;","        }","    }); ","","    ","    response.save(function(err) {","        if (err){","           res.status('400').send(\"Error\");","           return;","","        } else {","       ","","       ","    Request.findByIdAndUpdate(","    response.reqid,","    {$push: {\"responses\": response}},","    {safe: true, upsert: true},","    function(err, model) {","        console.log('here 3')","        console.log(req.body.recipId)","        ","        ","        User.findById(req.body.recipId, function(err, user) {","            if(err){","                 res.status('400').send(\"Error\");","                return","            }","            var gcm = require('node-gcm');","            var message = new gcm.Message({","                collapseKey: 'demo',","                delayWhileIdle: true,","                timeToLive: 0,","                data: {","                    message:'You have received a response!',","                    //key1: 'message1',","                    //key2: 'message2'","                }","            });","","            message.dryRun = false;","","            // Set up the sender with you API key","            var sender = new gcm.Sender('AIzaSyDMJx3zrQAcXZWioYXy_b3bp7-SVnb4E7U');","","            var eligible = [user.gcmRegId]; ","            sender.send(message, eligible, function (err, result) {","            if(err) {","                res.status('400').send(\"Error\");","                return","","                }else{","                    console.log(result);","                }    ","            });","","","","","","","        });","        if(!err){","        res.json({","            message: 'request sent!'","        });","        } else {","        res.status('400').send(\"Error\");","            return;","        }","    ","                   res.status('400').send(\"Error\");","","    });","   ","    }","    });","   ","}","","exports.getResponse = function(req, res) {","    console.log('looking for',req.params.user_id)","     Request.find({","        '_id': req.params.req_id","    }, function(err, response) {","                   res.status('400').send(\"Error\");","","        ","     ","       ","    });","    ","    ","}"]},{"start":{"row":0,"column":0},"end":{"row":142,"column":1},"action":"insert","lines":["var Response = require('../models/responses');","var Request = require('../models/requests');","var User = require('../models/users');","/** "," * [createResponse - called when the client sends a POST to /response]"," * @param  {[Object]} req [An object containing the HTTP request:"," *                        -userid"," *                        -reqid"," *                        -recipId"," *                        -time"," *                        -image (base64 encoded string)"," *                        -message"," *                        ]"," * @param  {[Object]} res [An object containing the HTTP response - this is a POST so should not be used.]"," */","exports.createResponse = function(req, res) {","","    //Create a new instance of the response model","    var response = new Response();","","    //Fill the model with the parameters in the HTTP request","    response.userid = req.body.userid; ","    response.reqid = req.body.reqid; ","    response.recipId = req.body.recipId ","    response.time = req.body.time; ","    response.image = req.body.image;","    response.message = req.body.message;","","    //Check to see if the user exists. They should/will do, ","    //this is just to be safe!","    User.count({","        _id: req.body.userid","    }, function(err, count) {","","         //If there is a user with the id (The count is > 0)","        if (count > 0) {","            //Find the user","            User.find({","                _id: req.body.userid","            }, function(err, user) {","","                //If the user can't be found (again they should and will), throw an error.","                //Otherwise add a point to  the users points, as the response has gained","                //them one point :)","                if (err) {","                    res.status('400').send(\"No user with that name!\");","                } else {","                    user.points = user.points + 1;","                }","            });","        } else {","            //The user was not found so throw a 400 error.","            res.status('400').send(\"User does not exsit\");","            return;","        }","    });","","    //We have reached this point so we know the response has been generated.","    //Therefore, we have to save the response","    response.save(function(err) {","        if (err) {","","            //If the was an error saving the response, throw an internal server error.","            res.status('500').send(\"Error\");","            return;","","        } else {","","            //If there was no problem saving the response","            //find the request it is for and add the response","            //to the requests list of responses.","            Request.findByIdAndUpdate(response.reqid, {$push: { \"responses\": response} }, {","                safe: true,","                upsert: true","            },","            function(err, model) {","                //Then find the user who send the request that this ","                //response is for and send them a push notification","                User.findById(req.body.recipId, function(err, user) {","                    //Handle the error!","                    if (err) {","                        res.status('400').send(\"Error\");","                        return","                    }","","                    //Initalise the google cloud messaging service","                    var gcm = require('node-gcm');","                    //Create a new message","                     var message = new gcm.Message({","                        collapseKey: 'demo',","                        delayWhileIdle: true,","                        timeToLive: 0,","                        data: {","                            message: 'You have received a response!',","                        }","                    });","","                    // Set up the sender with the API key","                    var sender = new gcm.Sender('AIzaSyDMJx3zrQAcXZWioYXy_b3bp7-SVnb4E7U');","                        ","                    //Should only be one eligible user in the array.","                    var eligible = [user.gcmRegId];","","                    //So send this user the push notifcation, handling the errors.","                    sender.send(message, eligible, function(err, result) {","                        if (err) {","                            res.status('400').send(\"Error\");","                            return","                        } else {","                            console.log(result);","                        }","                    });","                });","                if (!err) {","                    res.json({","                        message: 'request sent!'","                    });","                } else {","                    res.status('400').send(\"Error\");","                    return;","                }","                res.status('400').send(\"Error\");","            });","        }","    });","}","","/** "," * [getResponse called when the client sends a GET to /responses with a user id as a url parameter]"," * @param  {[Object]} req [Object containing the userID]"," * @param  {[Object]} res [Object containing the response - a list of the responses the given user has.]"," * @return {[void]}     [void]"," */","exports.getResponse = function(req, res) {","    //A very simple method, just find the responses with this users ID and return them!","    Request.find({","        '_id': req.params.req_id","    }, function(err, response) {","        res.status('400').send(\"Error\");","    });","","","}"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"insert","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":0,"column":1},"action":"insert","lines":["/"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":1},"end":{"row":0,"column":2},"action":"insert","lines":["/"]}]}]]},"ace":{"folds":[],"customSyntax":"javascript","scrolltop":0,"scrollleft":0,"selection":{"start":{"row":0,"column":2},"end":{"row":0,"column":2},"isBackwards":true},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1426848138375,"hash":"f065e70e1840cafec64228bfd2d0adf8008f3e34"}